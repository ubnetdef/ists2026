#!/usr/bin/env bash
#
# scan-malware.sh
# Scans for malware using ClamAV (if installed), rkhunter (if installed),
# and built-in checks for suspicious files and configs.
# Default: quick scan of /tmp, /var/tmp, /home only. Pass "/" for full system (slow).
# Run as root for full access; optional env: SKIP_CLAMAV, SKIP_RKHUNTER, FULL_RKHUNTER.
#

set -uo pipefail

REPORT_DIR="${REPORT_DIR:-/tmp/malware-scan}"
REPORT_FILE="$REPORT_DIR/report-$(date +%Y%m%d-%H%M%S).txt"

# Default: scan only high-risk dirs (fast). Pass "/" for full system scan (slow).
FAST_DEFAULT_DIRS="/tmp /var/tmp /home"
SCAN_DIR="${1:-}"
[[ -z "$SCAN_DIR" ]] && SCAN_DIR="$FAST_DEFAULT_DIRS"

# Optional: skip heavy scanners (set to 1 to disable)
SKIP_CLAMAV="${SKIP_CLAMAV:-0}"
SKIP_RKHUNTER="${SKIP_RKHUNTER:-0}"

# rkhunter: use --quick by default (faster). Set FULL_RKHUNTER=1 for full check.
FULL_RKHUNTER="${FULL_RKHUNTER:-0}"

# Optional: skip auto-install of ClamAV/rkhunter (set to 1 to disable)
SKIP_INSTALL="${SKIP_INSTALL:-0}"

mkdir -p "$REPORT_DIR"

# -----------------------------------------------------------------------------
# Auto-install ClamAV and rkhunter when run as root
# -----------------------------------------------------------------------------
if [[ $EUID -eq 0 ]] && [[ "$SKIP_INSTALL" != "1" ]]; then
    install_pkgs=()
    if [[ "$SKIP_CLAMAV" != "1" ]] && ! command -v clamscan &>/dev/null; then
        if command -v apt-get &>/dev/null; then
            install_pkgs+=(clamav clamav-daemon)
        elif command -v dnf &>/dev/null || command -v yum &>/dev/null; then
            install_pkgs+=(clamav clamav-update)
        else
            install_pkgs+=(clamav)
        fi
    fi
    if [[ "$SKIP_RKHUNTER" != "1" ]] && ! command -v rkhunter &>/dev/null; then
        install_pkgs+=(rkhunter)
    fi
    if [[ ${#install_pkgs[@]} -gt 0 ]]; then
        echo "Installing missing tools: ${install_pkgs[*]}"
        if command -v apt-get &>/dev/null; then
            apt-get update -qq && apt-get install -y "${install_pkgs[@]}"
        elif command -v dnf &>/dev/null; then
            dnf install -y "${install_pkgs[@]}"
        elif command -v yum &>/dev/null; then
            yum install -y "${install_pkgs[@]}"
        elif command -v zypper &>/dev/null; then
            zypper --non-interactive install "${install_pkgs[@]}"
        elif command -v pacman &>/dev/null; then
            pacman -Sy --noconfirm --needed "${install_pkgs[@]}"
        else
            echo "No supported package manager (apt-get, dnf, yum, zypper, pacman). Install ClamAV and rkhunter manually." >&2
        fi
        if command -v freshclam &>/dev/null; then
            echo "Updating ClamAV virus definitions..."
            freshclam --quiet 2>/dev/null || true
        fi
        echo ""
    fi
fi

mkdir -p "$REPORT_DIR"
exec 1> >(tee -a "$REPORT_FILE")
exec 2> >(tee -a "$REPORT_FILE" >&2)

echo "=============================================="
echo "Malware scan started: $(date -Iseconds)"
echo "Report: $REPORT_FILE"
echo "Scan target: $SCAN_DIR"
echo "=============================================="
echo ""

run_section() {
    echo "--- $1 ---"
}

# -----------------------------------------------------------------------------
# 1. ClamAV (virus scan)
# -----------------------------------------------------------------------------
run_section "ClamAV"
if [[ "$SKIP_CLAMAV" == "1" ]]; then
    echo "Skipped (SKIP_CLAMAV=1)."
elif command -v clamscan &>/dev/null; then
    echo "Scanning: $SCAN_DIR"
    echo "Running clamscan (skipping files >50MB, quick scan)..."
    # --max-filesize/--max-scansize skip huge files; -r recursive
    if clamscan -r --infected --no-summary --max-filesize=50M --max-scansize=50M $SCAN_DIR 2>/dev/null; then
        echo "ClamAV: No known malware detected."
    else
        echo "ClamAV: Scan finished with findings or errors (check output above)."
    fi
else
    echo "ClamAV not installed. Install with: apt install clamav clamav-daemon  (or equivalent)."
fi
echo ""

# -----------------------------------------------------------------------------
# 2. rkhunter (rootkit scan)
# -----------------------------------------------------------------------------
run_section "rkhunter"
if [[ "$SKIP_RKHUNTER" == "1" ]]; then
    echo "Skipped (SKIP_RKHUNTER=1)."
elif command -v rkhunter &>/dev/null; then
    if [[ "$FULL_RKHUNTER" == "1" ]]; then
        echo "Running rkhunter full check (--check --skip-keypress)..."
        rkhunter --check --skip-keypress 2>&1
    else
        echo "Running rkhunter quick check (--quick --skip-keypress)..."
        rkhunter --quick --skip-keypress 2>&1
    fi
    echo "rkhunter: Done. Set FULL_RKHUNTER=1 for full check."
else
    echo "rkhunter not installed. Install with: apt install rkhunter  (or equivalent)."
fi
echo ""

# -----------------------------------------------------------------------------
# 3. Built-in: world-writable SUID/SGID files (suspicious)
# -----------------------------------------------------------------------------
run_section "World-writable SUID/SGID files"
if [[ $EUID -ne 0 ]]; then
    echo "Run as root to scan full system for SUID/SGID."
else
    count=0
    for dir in $SCAN_DIR; do
        [[ -d "$dir" ]] || continue
        while IFS= read -r -d '' f; do
            echo "  SUSPICIOUS: $f"
            ((count++)) || true
        done < <(find "$dir" -xdev -maxdepth 20 -type f \( -perm -4000 -o -perm -2000 \) -perm -0002 2>/dev/null | head -100)
    done
    if [[ "${count:-0}" -eq 0 ]]; then
        echo "None found (good)."
    else
        echo "Found $count (showing up to 100). These should be reviewed."
    fi
fi
echo ""

# -----------------------------------------------------------------------------
# 4. Built-in: recently modified binaries in system paths (last 7 days)
# -----------------------------------------------------------------------------
run_section "Recently modified binaries (last 7 days)"
if [[ $EUID -ne 0 ]]; then
    echo "Run as root to scan system paths."
else
    for dir in /usr/bin /usr/sbin /bin /sbin; do
        [[ -d "$dir" ]] || continue
        while IFS= read -r -d '' f; do
            echo "  RECENT: $f"
        done < <(find "$dir" -xdev -type f -mtime -7 2>/dev/null | head -50)
    done
    echo "Review any unexpected recent changes."
fi
echo ""

# -----------------------------------------------------------------------------
# 5. Built-in: crontab / etc/cron.d entries for non-root
# -----------------------------------------------------------------------------
run_section "User crontabs and cron.d"
for u in $(cut -d: -f1 /etc/passwd 2>/dev/null); do
    c="$(crontab -l -u "$u" 2>/dev/null)"
    if [[ -n "$c" ]]; then
        echo "Crontab for $u:"
        echo "$c" | sed 's/^/  /'
        echo ""
    fi
done
if [[ -d /etc/cron.d ]]; then
    echo "Files in /etc/cron.d:"
    ls -la /etc/cron.d 2>/dev/null | sed 's/^/  /'
fi
echo ""

# -----------------------------------------------------------------------------
# 6. Built-in: LD_PRELOAD / suspicious env in systemd user services
# -----------------------------------------------------------------------------
run_section "LD_PRELOAD and systemd user overrides"
if grep -r "LD_PRELOAD" /etc/environment /etc/profile.d /etc/ld.so.preload 2>/dev/null; then
    echo "Review above for unexpected LD_PRELOAD."
else
    echo "No obvious LD_PRELOAD in common configs."
fi
echo ""

echo "=============================================="
echo "Scan finished: $(date -Iseconds)"
echo "Full report: $REPORT_FILE"
echo "=============================================="
